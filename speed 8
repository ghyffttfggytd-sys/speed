--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

--// Settings
local ESPEnabled = true
local LockTargetEnabled = false
local ESPColor = Color3.fromRGB(255,0,0)
local UpdateRate = 1 -- อัพเดททุก 1 วินาที

--// GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 200, 0, 100)
MainFrame.Position = UDim2.new(0, 50, 0, 50)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local ESPButton = Instance.new("TextButton")
ESPButton.Size = UDim2.new(0, 180, 0, 30)
ESPButton.Position = UDim2.new(0, 10, 0, 10)
ESPButton.Text = "ESP: ON"
ESPButton.Parent = MainFrame

local LockButton = Instance.new("TextButton")
LockButton.Size = UDim2.new(0, 180, 0, 30)
LockButton.Position = UDim2.new(0, 10, 0, 50)
LockButton.Text = "Lock Target: OFF"
LockButton.Parent = MainFrame

--// Toggle Functions
ESPButton.MouseButton1Click:Connect(function()
    ESPEnabled = not ESPEnabled
    ESPButton.Text = "ESP: " .. (ESPEnabled and "ON" or "OFF")
end)

LockButton.MouseButton1Click:Connect(function()
    LockTargetEnabled = not LockTargetEnabled
    LockButton.Text = "Lock Target: " .. (LockTargetEnabled and "ON" or "OFF")
end)

--// Highlight Management
local highlights = {}

local function createESP(player)
    if highlights[player] then return end
    if not player.Character then return end
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = player.Character
    highlight.FillColor = ESPColor
    highlight.OutlineColor = ESPColor
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = Workspace
    highlights[player] = highlight
end

local function removeESP(player)
    if highlights[player] then
        highlights[player]:Destroy()
        highlights[player] = nil
    end
end

--// Lock Target Function
local function getClosestTarget()
    local closest = nil
    local shortestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local origin = Camera.CFrame.Position
            local direction = player.Character.HumanoidRootPart.Position - origin
            local ray = Ray.new(origin, direction)
            local hitPart, _ = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character})
            
            if hitPart and hitPart:IsDescendantOf(player.Character) then
                local dist = (player.Character.HumanoidRootPart.Position - origin).Magnitude
                if dist < shortestDistance then
                    shortestDistance = dist
                    closest = player
                end
            end
        end
    end

    return closest
end

--// ESP Update Function
local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if ESPEnabled and player.Character then
            createESP(player)
        elseif not ESPEnabled then
            removeESP(player)
        end
    end
end

--// Initial ESP for existing players
updateESP()

--// Detect new players
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if ESPEnabled then
            createESP(player)
        end
    end)
end)

--// Cleanup on leave
Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end)

--// Main Loop for ESP & Lock Target
while true do
    updateESP()

    if LockTargetEnabled then
        local target = getClosestTarget()
        if target then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character.HumanoidRootPart.Position)
        end
    end

    wait(UpdateRate)
end
