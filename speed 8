-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Settings
local espEnabled = true
local lockTargetEnabled = true
local lockStrength = 100
local highlightList = {}
local currentTarget = nil

-- GUI
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 220, 0, 180)
Frame.Position = UDim2.new(0.1,0,0.1,0)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.BackgroundTransparency = 0.2
Frame.Parent = ScreenGui
Frame.Active = true
Frame.Draggable = true

-- สร้างปุ่ม รองรับทั้ง Mouse และ Touch
local function createButton(name, pos, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 200, 0, 40)
    btn.Position = pos
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = Frame

    -- รองรับ MouseClick
    btn.MouseButton1Click:Connect(callback)
    -- รองรับ TouchTap สำหรับมือถือ
    btn.TouchTap:Connect(callback)
    return btn
end

-- ปุ่มเปิด/ปิด ESP
local espButton = createButton("ESP: ON", UDim2.new(0,10,0,10), function()
    espEnabled = not espEnabled
    espButton.Text = "ESP: "..(espEnabled and "ON" or "OFF")
end)

-- ปุ่มเปิด/ปิด Lock Target
local lockButton = createButton("Lock Target: ON", UDim2.new(0,10,0,60), function()
    lockTargetEnabled = not lockTargetEnabled
    lockButton.Text = "Lock Target: "..(lockTargetEnabled and "ON" or "OFF")
end)

-- TextBox ปรับ Lock Strength
local strengthBox = Instance.new("TextBox")
strengthBox.Size = UDim2.new(0, 200, 0, 40)
strengthBox.Position = UDim2.new(0, 10, 0, 110)
strengthBox.PlaceholderText = "Lock Strength: "..lockStrength
strengthBox.Text = ""
strengthBox.BackgroundColor3 = Color3.fromRGB(50,50,50)
strengthBox.TextColor3 = Color3.new(1,1,1)
strengthBox.Parent = Frame
strengthBox.FocusLost:Connect(function()
    local val = tonumber(strengthBox.Text)
    if val and val >=1 and val <=400 then
        lockStrength = val
        strengthBox.PlaceholderText = "Lock Strength: "..lockStrength
    end
    strengthBox.Text = ""
end)

-- ฟังก์ชันสร้าง Highlight
local function createESP(player)
    if highlightList[player] then return end
    if not player.Character then return end
    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillColor = (player.Team == LocalPlayer.Team) and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
    highlight.OutlineColor = Color3.new(1,1,1)
    highlight.Parent = player:WaitForChild("PlayerGui")
    highlightList[player] = highlight
end

local function removeESP(player)
    if highlightList[player] then
        highlightList[player]:Destroy()
        highlightList[player] = nil
    end
end

-- อัปเดตเป้าหมาย
local function updateTarget()
    local closestDistance = math.huge
    local target = nil
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Team ~= LocalPlayer.Team and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local screenPos, onScreen = Camera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local distance = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    target = player
                end
            end
        end
    end
    currentTarget = target
end

-- อัปเดตทุกเฟรม
RunService.RenderStepped:Connect(function(delta)
    -- ESP
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if espEnabled then
                createESP(player)
            else
                removeESP(player)
            end
        end
    end

    -- Lock Target
    if lockTargetEnabled then
        updateTarget()
        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = currentTarget.Character.HumanoidRootPart.Position
            local camPos = Camera.CFrame.Position
            local lookDir = (targetPos - camPos)
            local lerpAmount = math.clamp(lockStrength/400, 0, 1) * delta
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(camPos, camPos + lookDir), lerpAmount)
        end
    end
end)

-- ผู้เล่นใหม่เข้ามา
Players.PlayerAdded:Connect(function(player)
    if espEnabled then
        createESP(player)
    end
end)

-- ซ่อน/โชว์ GUI ด้วยปุ่ม P
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.P then
        Frame.Visible = not Frame.Visible
    end
end)
