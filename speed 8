--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

--// Settings
local espEnabled = true
local lockTargetEnabled = true
local fovRadius = 150 -- ปรับขนาดวงกลม FOV
local enemyColor = Color3.fromRGB(255,0,0)
local friendColor = Color3.fromRGB(0,255,0)

--// Highlight เก็บ ESP
local highlights = {}
local currentTarget = nil

--// ฟังก์ชันสร้าง ESP
local function createESP(player)
    if highlights[player] then return highlights[player] end

    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillColor = (player.Team == LocalPlayer.Team and friendColor) or enemyColor
    highlight.OutlineColor = Color3.new(1,1,1)
    highlight.Parent = game.CoreGui
    highlights[player] = highlight
    return highlight
end

--// ฟังก์ชันลบ ESP
local function removeESP(player)
    if highlights[player] then
        highlights[player]:Destroy()
        highlights[player] = nil
    end
end

--// ฟังก์ชันหาศัตรูใกล้เคียงในวง FOV
local function getClosestTarget()
    local closest = nil
    local shortestDistance = fovRadius

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local screenPos, onScreen = Camera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local distance = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    closest = player
                end
            end
        end
    end
    return closest
end

--// วาดวงกลม FOV
local function drawFOV()
    local fovCircle = Instance.new("Frame")
    fovCircle.Size = UDim2.new(0,fovRadius*2,0,fovRadius*2)
    fovCircle.Position = UDim2.new(0.5,-fovRadius,0.5,-fovRadius)
    fovCircle.BackgroundTransparency = 0.8
    fovCircle.BorderSizePixel = 2
    fovCircle.BorderColor3 = Color3.fromRGB(0,255,0)
    fovCircle.Parent = game.CoreGui
end

--// เรียลไทม์
RunService.RenderStepped:Connect(function()
    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                createESP(player)
            end
        end
    else
        for player, _ in pairs(highlights) do
            removeESP(player)
        end
    end

    if lockTargetEnabled then
        currentTarget = getClosestTarget()
        -- ตัวอย่าง: แสดง print ชื่อเป้าล็อค
        if currentTarget then
            print("Locked Target:", currentTarget.Name)
        end
    end
end)

--// ปุ่ม UI บนมือถือ
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)

local ESPButton = Instance.new("TextButton", ScreenGui)
ESPButton.Size = UDim2.new(0,100,0,50)
ESPButton.Position = UDim2.new(0,10,0,10)
ESPButton.Text = "ESP ❌"
ESPButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    ESPButton.Text = espEnabled and "ESP ✔️" or "ESP ❌"
end)

local LockButton = Instance.new("TextButton", ScreenGui)
LockButton.Size = UDim2.new(0,100,0,50)
LockButton.Position = UDim2.new(0,10,0,70)
LockButton.Text = "Lock ❌"
LockButton.MouseButton1Click:Connect(function()
    lockTargetEnabled = not lockTargetEnabled
    LockButton.Text = lockTargetEnabled and "Lock ✔️" or "Lock ❌"
end)

drawFOV()
