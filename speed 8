-- LocalScript (วางใน StarterPlayerScripts หรือ PlayerGui)

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Settings
local espEnabled = true
local lockEnabled = true
local netEnabled = true
local lockStrength = 100 -- 1..400
local highlightTable = {}
local currentTarget = nil

-- Helper: ตรวจสอบว่าตัวละครพร้อม
local function characterIsValid(player)
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    return hrp and hum and hum.Health > 0
end

-- GUI
local screenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
screenGui.ResetOnSpawn = false

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 260, 0, 260)
frame.Position = UDim2.new(0.05,0,0.1,0)
frame.BackgroundColor3 = Color3.fromRGB(28,28,30)
frame.Parent = screenGui
frame.Active = true
frame.Draggable = true

local uiPadding = 10

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -uiPadding*2, 0, 30)
title.Position = UDim2.new(0, uiPadding, 0, uiPadding)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.Text = "AimLock Notebook"

local function makeButton(text, y)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -uiPadding*2, 0, 36)
    btn.Position = UDim2.new(0, uiPadding, 0, y)
    btn.BackgroundColor3 = Color3.fromRGB(45,45,48)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 16
    btn.Text = text
    btn.Parent = frame
    return btn
end

local espBtn = makeButton("ESP: ON", 50)
local lockBtn = makeButton("Lock: ON", 96)
local netBtn = makeButton("Net: ON", 142)

-- Slider
local sliderLabel = Instance.new("TextLabel", frame)
sliderLabel.Size = UDim2.new(1, -uiPadding*2, 0, 24)
sliderLabel.Position = UDim2.new(0, uiPadding, 0, 188)
sliderLabel.BackgroundTransparency = 1
sliderLabel.TextColor3 = Color3.new(1,1,1)
sliderLabel.Font = Enum.Font.SourceSans
sliderLabel.TextSize = 14
sliderLabel.Text = "Lock Strength: "..lockStrength

local sliderBar = Instance.new("Frame", frame)
sliderBar.Size = UDim2.new(1, -uiPadding*2, 0, 18)
sliderBar.Position = UDim2.new(0, uiPadding, 0, 212)
sliderBar.BackgroundColor3 = Color3.fromRGB(60,60,64)
sliderBar.BorderSizePixel = 0

local sliderFill = Instance.new("Frame", sliderBar)
sliderFill.Size = UDim2.new(lockStrength/400, 0, 1, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(120,180,255)
sliderFill.BorderSizePixel = 0

local sliderKnob = Instance.new("ImageButton", sliderBar)
sliderKnob.Size = UDim2.new(0, 18, 1, 0)
sliderKnob.BackgroundTransparency = 1
sliderKnob.Image = "rbxassetid://3570695787"
sliderKnob.Position = UDim2.new(lockStrength/400, -9, 0, 0)

-- Toggle GUI
local toggleGuiBtn = Instance.new("TextButton", frame)
toggleGuiBtn.Size = UDim2.new(0, 28, 0, 20)
toggleGuiBtn.Position = UDim2.new(1, -uiPadding - 28, 0, uiPadding)
toggleGuiBtn.BackgroundColor3 = Color3.fromRGB(80,80,85)
toggleGuiBtn.TextColor3 = Color3.new(1,1,1)
toggleGuiBtn.Text = "✕"
toggleGuiBtn.Font = Enum.Font.SourceSans
toggleGuiBtn.TextSize = 14

-- Button callbacks
local function activateButton(btn, callback)
    btn.Activated:Connect(callback)
end

activateButton(espBtn, function()
    espEnabled = not espEnabled
    espBtn.Text = "ESP: "..(espEnabled and "ON" or "OFF")
    if not espEnabled then
        for p,h in pairs(highlightTable) do
            if h then h:Destroy() end
        end
        highlightTable = {}
    end
end)

activateButton(lockBtn, function()
    lockEnabled = not lockEnabled
    lockBtn.Text = "Lock: "..(lockEnabled and "ON" or "OFF")
end)

activateButton(netBtn, function()
    netEnabled = not netEnabled
    netBtn.Text = "Net: "..(netEnabled and "ON" or "OFF")
end)

activateButton(toggleGuiBtn, function()
    frame.Visible = not frame.Visible
end)

-- Slider drag logic
local dragging = false
local function updateSlider(x)
    local absPos = sliderBar.AbsolutePosition
    local width = sliderBar.AbsoluteSize.X
    local rel = (x - absPos.X)/width
    rel = math.clamp(rel,0,1)
    lockStrength = math.floor(rel*399)+1
    sliderFill.Size = UDim2.new(rel,0,1,0)
    sliderKnob.Position = UDim2.new(rel,-9,0,0)
    sliderLabel.Text = "Lock Strength: "..lockStrength
end

sliderKnob.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
    end
end)
sliderKnob.InputEnded:Connect(function(input)
    dragging = false
end)
sliderBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        updateSlider(input.Position.X)
        dragging = true
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        updateSlider(input.Position.X)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)

-- ESP functions
local function createHighlight(player)
    if highlightTable[player] then return end
    if not characterIsValid(player) then return end
    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.6
    highlight.OutlineTransparency = 0
    highlight.FillColor = Color3.fromRGB(255,0,0) -- Enemy = red
    highlight.Parent = Workspace
    highlightTable[player] = highlight
end

local function removeHighlight(player)
    local h = highlightTable[player]
    if h then
        h:Destroy()
        highlightTable[player] = nil
    end
end

Players.PlayerRemoving:Connect(function(player)
    removeHighlight(player)
end)

-- Lock target: closest to screen center
local function findBestTarget()
    local best = nil
    local bestDist = math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and characterIsValid(p) then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y)-center).Magnitude
                    if dist < bestDist then
                        bestDist = dist
                        best = p
                    end
                end
            end
        end
    end
    return best
end

-- Main loop
RunService.RenderStepped:Connect(function(delta)
    if not netEnabled then return end

    -- ESP
    if espEnabled then
        for _, p in pairs(
